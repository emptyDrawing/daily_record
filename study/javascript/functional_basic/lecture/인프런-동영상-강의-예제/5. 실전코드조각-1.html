<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>5. 실전코드조각-1</title>
  <script src="js/partial.js"></script>
  <script src="js/_2.js"></script>
</head>
<body>

<script>
var users = [
  { id: 101, name: 'ID' },
  { id: 102, name: 'BJ' },
  { id: 103, name: 'PJ' },
  { id: 104, name: 'HA' },
  { id: 105, name: 'JE' },
  { id: 106, name: 'JI' }
];

var posts = [
  { id: 201, body: '내용1', user_id: 101 },
  { id: 202, body: '내용2', user_id: 102 },
  { id: 203, body: '내용3', user_id: 103 },
  { id: 204, body: '내용4', user_id: 102 },
  { id: 205, body: '내용5', user_id: 101 },
];

var comments = [
  { id: 301, body: '댓글1', user_id: 105, post_id: 201 },
  { id: 302, body: '댓글2', user_id: 104, post_id: 201 },
  { id: 303, body: '댓글3', user_id: 104, post_id: 202 },
  { id: 304, body: '댓글4', user_id: 105, post_id: 203 },
  { id: 305, body: '댓글5', user_id: 106, post_id: 203 },
  { id: 306, body: '댓글6', user_id: 106, post_id: 204 },
  { id: 307, body: '댓글7', user_id: 102, post_id: 205 },
  { id: 308, body: '댓글8', user_id: 103, post_id: 204 },
  { id: 309, body: '댓글9', user_id: 103, post_id: 202 },
  { id: 310, body: '댓글10', user_id: 105, post_id: 201 }
];

// 1. 특정인의 posts의 모든 comments 거르기
let posts_by = (attr) => _.where(posts, attr);

let comments_by_posts = _.pipe(
  _.pluck('id'),
  (postIds) => _.filter(comments, comment => _.contains(postIds, comment.post_id))
)

var f1 = _.pipe( posts_by, comments_by_posts);

console.log(f1({user_id : 101}));

// 2. 특정인의 posts에 comments를 단 친구의 이름들 뽑기
let comments_to_user_name = 
  _.map(comment => _.find(users, user => user.id == comment.user_id).name );

var f2 = _.pipe(f1, comments_to_user_name, _.uniq);  

console.log(f2({user_id : 101}));

// 3. 특정인의 posts에 comments를 단 친구들 카운트 정보

var f3 = _.pipe(f1, comments_to_user_name, _.count_by);

console.log(f3({user_id : 101}));

// 4. 특정인이 comment를 단 posts 거르기
_.go(
  _.where(comments, {user_id : 105}),
  _.pluck('post_id'),
  _.uniq,
  (postsIds) => _.filter(posts, (post) =>_.contains(postsIds, post.id)),
  console.log
)
// 5. users + posts + comments (index_by와 group_by로 효율 높이기)

var users2 = _.index_by(users, 'id');

var comments2 = _.go(
  comments,
  _.map(
    (comment) => {
      return _.extend(
        {user : users2[comment.user_id]}, comment);
    }
  ),
  _.group_by('post_id')
);
console.log("comments2",comments2);

var posts2 = _.go(
  posts,
  _.map(
    (post) => {
      return _.extend({
        comments: comments2[post.id] || [],
        user : users2[post.user_id] 
      }, post);
    }
  )
)
console.log("posts2", posts2);

var posts3 = _.group_by(posts2,'user_id')

console.log("posts3",posts3);

var users3 = _.map(users2, (user) => {
  return _.extend({
    posts: posts3[user.id] || []
  }, user)
});

console.log("users3",users3);

// 5.1. 특정인의 posts의 모든 comments 거르기
var user = users3[0];
console.log(
  _.flatten(_.deep_pluck(user,'posts.comments'))
);
// _.go(
//   user.posts,
//   _.pluck('comments'),
//   _.flatten,
//   console.log
// )

// 5.2. 특정인의 posts에 comments를 단 친구의 이름들 뽑기
console.log(
  _go(
    user,
    _.deep_pluck('posts.comments.user.name'),
    _.uniq
  )
);
// 5.3. 특정인의 posts에 comments를 단 친구들 카운트 정보

_go(
  user,
  _.deep_pluck('posts.comments.user.name'),
  _.count_by,
  console.log
)

// 5.4. 특정인이 comment를 단 posts 거르기
_go(
  posts2,
  _.filter(post => _.find(post.comments, comment => comment.user_id == 105)),
  console.log
)

</script>

</body>
</html>